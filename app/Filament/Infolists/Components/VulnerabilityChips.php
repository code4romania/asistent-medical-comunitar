<?php

declare(strict_types=1);

namespace App\Filament\Infolists\Components;

use App\Contracts\HasVulnerabilityData;
use App\Models\Catagraphy;
use App\Models\Recommendation;
use App\Models\Vulnerability\Vulnerability;
use Filament\Infolists\Components\Entry;
use Illuminate\Support\HtmlString;
use Illuminate\Support\Str;

class VulnerabilityChips extends Entry
{
    protected string $view = 'filament.infolists.components.vulnerability-chips';

    protected function setUp(): void
    {
        parent::setUp();

        $this->placeholder(
            fn () => new HtmlString(__('catagraphy.vulnerability.none', [
                'vulnerability' => Str::lower($this->getLabel()),
            ]))
        );

        $this->state(function (Catagraphy|Recommendation $record) {
            $vulnerabilities = Vulnerability::cachedList();

            return collect($record?->{$this->getName()})
                ->map(fn (mixed $vulnerability) => match (true) {
                    $vulnerability instanceof HasVulnerabilityData => $vulnerability->vulnerabilityData(),
                    default => $vulnerabilities->get($vulnerability)?->vulnerabilityData(),
                })
                ->filter();
        });
    }
}
